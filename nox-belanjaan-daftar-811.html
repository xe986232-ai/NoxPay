<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoxPay Admin - Control Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #0b0f1a;
            --card-bg: #161b2c;
            --nox-blue: #007bff;
            --accent-pink: #ff4d94;
            --success: #00e676;
            --pending: #ffc107;
            --text-muted: #8b949e;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg-main); 
            color: #ffffff;
            margin: 0; 
            padding: 10px;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        /* Login Form */
        #login-form {
            max-width: 350px;
            margin: 80px auto;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }

        #login-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background: #0b0f1a;
            border: 1px solid #333;
            border-radius: 8px;
            color: white;
            box-sizing: border-box;
        }

        #login-form button {
            width: 100%;
            padding: 12px;
            background: var(--nox-blue);
            border: none;
            color: white;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Header */
        .header-flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
        }

        /* Tabel Responsif */
        .table-card {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .scroll-wrapper { 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch;
        }

        table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 800px;
        }

        th { 
            padding: 15px 10px; 
            text-align: left; 
            font-size: 0.65rem; 
            text-transform: uppercase; 
            color: var(--nox-blue); 
            background: rgba(0, 123, 255, 0.05);
        }

        td { 
            padding: 12px 10px; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            font-size: 0.8rem; 
        }

        .target-id { color: var(--accent-pink); font-weight: 700; background: rgba(255,77,148,0.1); padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 0.7rem; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; border: 1px solid; }
        .st-pending { color: var(--pending); border-color: var(--pending); }
        .st-success { color: var(--success); border-color: var(--success); }

        .btn-action {
            background: var(--success);
            color: #000;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            cursor: pointer;
        }

        #btn-logout {
            background: none;
            color: #ff4d4d;
            border: 1px solid #ff4d4d;
            padding: 6px 15px;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        /* Mobile Optimization */
        @media (max-width: 600px) {
            body { padding: 8px; }
            .header-flex h2 { font-size: 1.2rem; }
            td { font-size: 0.75rem; }
        }
    </style>
</head>
<body>

    <div id="login-form">
        <h2 style="color:var(--nox-blue)">NoxPay Admin</h2>
        <input type="email" id="email" placeholder="Email Admin">
        <input type="password" id="password" placeholder="Password">
        <button onclick="handleLogin()">Login</button>
    </div>

    <div id="admin-content" class="container" style="display:none;">
        <div class="header-flex">
            <div>
                <h2 style="margin:0;">Panel Database</h2>
                <div style="cursor: pointer; margin-top: 5px;" onclick="toggleStatus()">
                    <small id="admin-status-text" style="color:var(--text-muted); font-weight: 600;">Memuat Status...</small>
                </div>
            </div>
            <button id="btn-logout" onclick="logout()">Logout</button>
        </div>

        <div class="table-card">
            <div class="scroll-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Waktu</th>
                            <th>User</th>
                            <th>Produk & Nominal</th>
                            <th>ID Trx</th>
                            <th>Admin</th> 
                            <th>Harga</th>
                            <th>Status / Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="order-rows">
                        <tr><td colspan="7" style="text-align:center; padding:40px;">Memuat data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="table-card" style="padding: 20px;">
            <h3 style="margin-top:0; font-size: 1rem; color: var(--nox-blue);">Kirim Notifikasi ke User</h3>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="input-pesan-admin" placeholder="Ketik pengumuman atau promo di sini..." 
                    style="flex: 1; padding: 12px; background: #0b0f1a; border: 1px solid #333; border-radius: 8px; color: white;">
                <button onclick="kirimNotifikasi()" 
                    style="padding: 12px 25px; background: var(--nox-blue); border: none; color: white; font-weight: bold; border-radius: 8px; cursor: pointer;">
                    Kirim
                </button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC9_F1HGMru6vVdBlTqdxfJ-_6wb9CFSyU",
            authDomain: "noxpay-admin.firebaseapp.com",
            databaseURL: "https://noxpay-admin-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "noxpay-admin",
            storageBucket: "noxpay-admin.firebasestorage.app",
            messagingSenderId: "212794945472",
            appId: "1:212794945472:web:bd803bb3e71b48ea99a225"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // 1. MONITOR LOGIN STATUS
        auth.onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                loadOrders();
                monitorAdminStatus();
            } else {
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('admin-content').style.display = 'none';
            }
        });

        // 2. MONITOR & TAMPILKAN STATUS ADMIN
        function monitorAdminStatus() {
            const user = auth.currentUser;
            if (user) {
                const statusRef = db.ref('status_admin/' + user.uid);
                statusRef.on('value', (snapshot) => {
                    const status = snapshot.val() || 'offline';
                    const statusElement = document.getElementById('admin-status-text');
                    if (statusElement) {
                        if (status === 'online') {
                            statusElement.innerHTML = '● ONLINE';
                            statusElement.style.color = 'var(--success)';
                        } else {
                            statusElement.innerHTML = '○ OFFLINE';
                            statusElement.style.color = 'var(--text-muted)';
                        }
                    }
                });
            }
        }

        // 3. FUNGSI UBAH STATUS (TOGGLE)
        function toggleStatus() {
            const user = auth.currentUser;
            if (user) {
                const statusRef = db.ref('status_admin/' + user.uid);
                statusRef.once('value').then((snapshot) => {
                    const currentStatus = snapshot.val() || 'offline';
                    const newStatus = currentStatus === 'online' ? 'offline' : 'online';
                    statusRef.set(newStatus);
                });
            }
        }

        function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(email, password).catch(e => alert(e.message));
        }

        function loadOrders() {
            db.ref('orders').on('value', (snapshot) => {
                const tbody = document.getElementById('order-rows');
                tbody.innerHTML = "";
                
                if (!snapshot.exists()) {
                    tbody.innerHTML = "<tr><td colspan='7' style='text-align:center; padding:20px;'>Database Kosong</td></tr>";
                    return;
                }

                let orders = [];
                snapshot.forEach(child => {
                    let data = child.val();
                    data.key = child.key;
                    orders.push(data);
                });
                
                orders.reverse().forEach((data) => {
                    const statusVal = data.status || 'Pending';
                    const isPending = statusVal.toLowerCase() === 'pending' || statusVal === 'BELUM DIBAYAR';
                    const statusClass = isPending ? 'st-pending' : 'st-success';
                    
                    let displayAdmin = data.admin_name || "-";
                    if (displayAdmin === "-") {
                        const noAdminData = data.admin_tujuan || data.tujuan || "";
                        if (noAdminData.includes("6283198721162")) displayAdmin = "Wall";
                        else if (noAdminData.includes("6283129555763")) displayAdmin = "Rizz";
                    }

                    const actionHtml = isPending 
                        ? `<button class="btn-action" onclick="konfirmasiTransaksi('${data.key}')">Terima</button>`
                        : `<span style="color:var(--success); font-size:10px;">SELESAI</span>`;

                    tbody.innerHTML += `
                    <tr>
                        <td style="font-size:10px; color:var(--text-muted)">${data.waktu_masuk || '-'}</td>
                        <td><b>${data.nama_user || data.buyerName || 'User'}</b></td>
                        <td>
                            <div style="font-weight:600">${data.product || '-'}</div>
                            <div style="font-size:10px; color:var(--text-muted)">${data.nominal || '-'}</div>
                        </td>
                        <td><span class="target-id">${data.key}</span></td>
                        <td style="font-weight:bold; color:#00e676">${displayAdmin}</td>
                        <td style="color:#79c0ff; font-weight:700">Rp${data.price || '0'}</td>
                        <td>
                            <span class="badge ${statusClass}">${statusVal}</span><br>
                            <div style="margin-top:5px">${actionHtml}</div>
                        </td>
                    </tr>`;
                });
            });
        }

        function konfirmasiTransaksi(orderID) {
            if (confirm("Konfirmasi Pembayaran " + orderID + "?")) {
                db.ref('orders/' + orderID).update({
                    status: "Success",
                    waktu_selesai: new Date().toLocaleString('id-ID')
                }).then(() => alert("Berhasil Terkonfirmasi!"));
            }
        }

        function kirimNotifikasi() {
            const pesanInput = document.getElementById('input-pesan-admin');
            const teks = pesanInput.value;
            const jamSekarang = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

            if (teks.trim() !== "") {
                db.ref('notifikasi').push({
                    pesan: teks,
                    waktu: jamSekarang,
                    timestamp: Date.now()
                }).then(() => {
                    alert("Notifikasi terkirim ke user!");
                    pesanInput.value = "";
                }).catch((e) => alert("Gagal kirim: " + e.message));
            } else {
                alert("Harap isi pesan terlebih dahulu!");
            }
        }

        function logout() { auth.signOut().then(() => location.reload()); }
    </script>
</body>
</html>
