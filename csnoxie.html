<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Noxie AI Ultra - NoxPay Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #0066ff;
            --noxie-grad: linear-gradient(135deg, #0066ff 0%, #8b5cf6 100%);
            --bg-gradient: linear-gradient(180deg, #f8faff 0%, #f1f5f9 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg-gradient); 
            height: 100vh; 
            height: -webkit-fill-available;
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            position: fixed; 
            width: 100%; 
            top: 0; 
            left: 0; 
        }

        header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); padding: 12px 16px; border-bottom: 1px solid rgba(0,0,0,0.08); display: flex; align-items: center; justify-content: space-between; z-index: 100; flex-shrink: 0; }
        
        .noxie-profile { display: flex; align-items: center; gap: 12px; }
        .noxie-avatar-container {
            width: 48px; height: 48px; 
            padding: 2px;
            background: var(--noxie-grad);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,102,255,0.3);
        }
        .noxie-avatar-container img {
            width: 100%; height: 100%;
            border-radius: 50%;
            object-fit: cover;
            background: #eee;
            border: 2px solid white;
        }

        /* Tombol Komunitas Baru */
        .btn-community {
            display: flex;
            align-items: center;
            gap: 6px;
            background: #f1f5f9;
            padding: 8px 12px;
            border-radius: 12px;
            text-decoration: none;
            transition: all 0.2s;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .btn-community:active { transform: scale(0.95); background: #e2e8f0; }
        .btn-community span { font-size: 11px; font-weight: 800; color: #1e293b; }

        #chat-container { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; width: 100%; scrollbar-width: none; scroll-behavior: smooth; padding-bottom: 100px; }
        #chat-container::-webkit-scrollbar { display: none; }

        .msg-wrapper { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-start; 
            margin-bottom: 30px; 
            animation: slide 0.4s ease-out; 
            max-width: 100%;
            width: 100%;
        }
        
        .msg-wrapper.reverse {
            align-items: flex-end;
        }

        .char-container { 
            width: 120px; 
            margin-top: 5px; 
            z-index: 2;
            position: relative;
        }

        .char-container img { 
            width: 100%; 
            height: auto; 
            filter: drop-shadow(0 10px 8px rgba(0,0,0,0.2)); 
            display: block;
        }

        .msg { 
            padding: 16px 20px; 
            border-radius: 24px; 
            font-size: 13.8px; 
            line-height: 1.6; 
            word-wrap: break-word; 
            position: relative;
            z-index: 1;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08); 
            max-width: 90%;
        }

        @keyframes slide { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .msg-noxie { 
            background: white; 
            border: 1px solid rgba(0,0,0,0.05); 
            color: #1e293b; 
            width: fit-content;
            min-width: 150px;
        }

        .msg-noxie::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 30px;
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-top: 12px solid white;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.05));
        }

        .reverse .msg-noxie::after {
            left: auto;
            right: 30px;
        }

        .msg-user { 
            align-self: flex-end; 
            background: var(--primary); 
            color: white; 
            border-bottom-right-radius: 4px; 
            font-weight: 600; 
            box-shadow: 0 8px 20px rgba(0,102,255,0.25); 
            margin-left: auto;
            max-width: 80%;
        }

        .typing { font-size: 11px; color: #64748b; text-align: center; margin: 8px 0; display: none; font-weight: 700; letter-spacing: 0.5px; }
        
        .menu-trigger {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--noxie-grad);
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            font-weight: 800;
            font-size: 13px;
            box-shadow: 0 10px 20px rgba(0,102,255,0.4);
            z-index: 1000;
            cursor: pointer;
            border: 2px solid white;
            display: none;
        }

        .drop-up-menu {
            position: fixed;
            bottom: -100%;
            left: 0;
            width: 100%;
            background: white;
            border-radius: 24px 24px 0 0;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
            z-index: 1001;
            transition: bottom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .drop-up-menu.active { bottom: 0; }

        .menu-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(3px);
            z-index: 1000;
            display: none;
        }

        .chip { 
            background: #f8fafc; padding: 12px; border-radius: 14px; 
            font-size: 11.5px; font-weight: 800; color: #334155; border: 1px solid #e2e8f0; 
            cursor: pointer; text-align: center;
        }
        .chip:active { transform: scale(0.92); background: #f1f5f9; color: var(--primary); }

        .info-card { background: #f8fafc; border-radius: 14px; border: 1px solid #e2e8f0; padding: 12px; margin: 8px 0; width: 100%; }
        .admin-status-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #cbd5e1; gap: 10px; }
        .order-card { background: #f0f7ff; border-radius: 15px; padding: 14px; margin-top: 10px; border-left: 6px solid var(--primary); box-shadow: 0 4px 10px rgba(0,102,255,0.05); }
        .status-badge { display: inline-block; padding: 3px 10px; border-radius: 6px; font-size: 10px; font-weight: 800; color: white; margin-top: 8px; text-transform: uppercase; }
        .alert-box { background: #fff1f2; color: #be123c; padding: 10px; border-radius: 10px; font-size: 11.5px; margin-top: 10px; font-weight: 600; border: 1px solid #fecdd3; }
        
        .vote-container { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
        .vote-btn { background: white; border: 2px solid #e2e8f0; padding: 10px; border-radius: 12px; font-size: 12px; font-weight: 700; color: #1e293b; cursor: pointer; transition: all 0.2s; text-align: center; }
        .vote-btn:active { transform: scale(0.95); background: #f0f7ff; border-color: var(--primary); }

        /* Style Baru untuk Step Order */
        .step-order { display: flex; gap: 12px; margin-bottom: 12px; align-items: flex-start; }
        .step-num { background: var(--primary); color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; flex-shrink: 0; }
        .step-text { font-size: 12.5px; color: #334155; line-height: 1.4; }
    </style>
</head>
<body>

    <header>
        <div class="noxie-profile">
            <div class="noxie-avatar-container">
                <img src="HERO/noxie.jpg" alt="Noxie Photo">
            </div>
            <div class="noxie-info">
                <h1 style="font-size: 15px; font-weight: 800; color: #1e293b;">Noxie<span style="font-size: 9px; background: var(--noxie-grad); color: #fff; padding: 2px 7px; border-radius: 20px;">ULTRA</span></h1>
                <p style="font-size: 10px; color: #22c55e; font-weight: 700;">‚óè Online</p>
            </div>
        </div>
        <a href="chatcomunity.html" class="btn-community">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1e293b" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
            <span>Komunitas</span>
        </a>
    </header>

    <div id="chat-container"></div>
    <div id="typing-ui" class="typing">Noxie sedang memproses data... ‚è≥</div>

    <div class="menu-trigger" id="menu-btn" onclick="toggleMenu()">‚ö° Menu Bantuan</div>
    <div class="menu-overlay" id="overlay" onclick="toggleMenu()"></div>
    <div class="drop-up-menu" id="drop-menu">
        <div class="chip" onclick="handleMenu('Cek Pesanan')">Cek Pesanan</div>
        <div class="chip" onclick="window.open('https://noxpay.my.id', '_blank')">Web NoxPay</div>
        <div class="chip" onclick="handleMenu('Cara Order')">Cara Order</div>
        <div class="chip" onclick="handleMenu('Link Grup Noxpay')">Grup Noxpay</div>
        <div class="chip" onclick="handleMenu('Cek Status Admin')">Status Admin</div>
        <div class="chip" onclick="handleMenu('Cek Saldo Admin')">Saldo Admin</div>
        <div class="chip" onclick="handleMenu('Produk Baru')">Produk Baru</div>
        <div class="chip" onclick="handleMenu('Sistem Blokir')">Aturan Blokir</div>
        <div class="chip" onclick="location.reload()">Refresh Chat</div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC9_F1HGMru6vVdBlTqdxfJ-_6wb9CFSyU",
            authDomain: "noxpay-admin.firebaseapp.com",
            databaseURL: "https://noxpay-admin-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "noxpay-admin",
            storageBucket: "noxpay-admin.firebasestorage.app",
            messagingSenderId: "212794945472",
            appId: "1:212794945472:web:bd803bb3e71b48ea99a225"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let responseCount = 0;

        function toggleMenu() {
            const menu = document.getElementById('drop-menu');
            const overlay = document.getElementById('overlay');
            menu.classList.toggle('active');
            overlay.style.display = menu.classList.contains('active') ? 'block' : 'none';
        }

        function handleMenu(cmd) {
            toggleMenu();
            if(cmd === 'Cek Pesanan') showIdInput();
            else quickAsk(cmd);
        }

        function getAutoUserID() {
            let rawID = localStorage.getItem('nox_user_id'); 
            let finalID = rawID || "593086";
            return finalID.startsWith("USER-") ? finalID : "USER-" + finalID;
        }

        window.onload = () => {
            const welcomeMsg = `<b>Halo Bang! üëã</b><br>Kenalin, aku <b>Noxie</b>. Senang sekali bisa bertemu kamu lagi! Ada yang bisa aku bantu hari ini? ‚ú®`;
            typeWriterMessage(welcomeMsg, true, "HERO/noxie2.png");
        };

        async function quickAsk(cmd) {
            addMessage(cmd, 'user');
            document.getElementById('typing-ui').style.display = 'block';
            let response = "";
            let customImg = "HERO/noxie2.png"; 

            if (cmd === 'Cek Status Admin') {
                customImg = "HERO/status.png";
                response = await getAdminDetailedInfo('status');
            } else if (cmd === 'Cek Saldo Admin') {
                customImg = "HERO/saldo.png";
                response = await getAdminDetailedInfo('balance');
            } else if (cmd === 'Produk Baru') {
                customImg = "HERO/noxie2.png";
                response = `Akan segera hadir produk baru yaitu <b>Sarung Jempol AP King V1/V2</b>! üî•<br><br>Boss lebih tertarik yang mana nih? Yuk bantu Noxie voting biar makin semangat stoknya! üëá<div class="vote-container"><div class="vote-btn" onclick="submitVote('V1')">üëë Pilih AP King V1</div><div class="vote-btn" onclick="submitVote('V2')">‚ö° Pilih AP King V2</div></div>`;
            } else if (cmd === 'Sistem Blokir') {
                customImg = "HERO/warning.png";
                response = "‚ö†Ô∏è <b>INFORMASI PENTING BOSS!</b> ‚ö†Ô∏è<br><br>Sistem kami akan memblokir pembelian secara otomatis jika ada transaksi yang <b>Belum Dibayar</b> selama lebih dari <b>24 Jam</b>.<br><br>Mohon segera selesaikan pembayaran agar transaksi kamu tidak terhambat ya! üôèüöÄ";
            } else if (cmd === 'Cara Order') {
                customImg = "HERO/noxie2.png";
                response = `
                <div style="width:100%;">
                    <h3 style="margin-bottom:15px; font-size:16px; font-weight:800;">Cara Belanja di NoxPay</h3>
                    <div class="step-order"><div class="step-num">1</div><div class="step-text">Pilih kategori layanan (Game, Pulsa, atau E-Wallet).</div></div>
                    <div class="step-order"><div class="step-num">2</div><div class="step-text">Masukkan <b>Nomor HP</b> atau <b>ID Akun</b> tujuan dengan benar.</div></div>
                    <div class="step-order"><div class="step-num">3</div><div class="step-text">Pilih <b>Nominal</b> produk yang ingin kamu beli.</div></div>
                    <div class="step-order"><div class="step-num">4</div><div class="step-text">Klik <b>Beli Sekarang</b>, cek detailnya, lalu klik <b>Bayar</b>.</div></div>
                    <div class="step-order"><div class="step-num">5</div><div class="step-text">Kamu akan diarahkan ke WhatsApp untuk menyelesaikan pembayaran.</div></div>
                </div>`;
            } else if (cmd === 'Link Grup Noxpay') {
                customImg = "HERO/noxie2.png";
                response = "Untu link grup Noxpay ada disini ya banke langsung join aja:<br><br><a href='https://chat.whatsapp.com/FGHOFKwPcu51ttEGO10Ryr' target='_blank' style='color:var(--primary); font-weight:bold;'>https://chat.whatsapp.com/FGHOFKwPcu51ttEGO10Ryr</a>";
            }

            document.getElementById('typing-ui').style.display = 'none';
            typeWriterMessage(response, false, customImg);
        }

        async function submitVote(type) {
            addMessage(`Saya pilih AP King ${type}!`, 'user');
            document.getElementById('typing-ui').style.display = 'block';
            try {
                const voteRef = db.ref('product_votes').child(type);
                await voteRef.transaction((current) => (current || 0) + 1);
                document.getElementById('typing-ui').style.display = 'none';
                typeWriterMessage(`Terima kasih Boss atas votingnya! ü´° Pilihan <b>AP King ${type}</b> sudah Noxie catat di database ya! ‚ú®`, false, "HERO/noxie2.png");
            } catch (e) {
                document.getElementById('typing-ui').style.display = 'none';
                typeWriterMessage("Waduh, gagal kirim vote ke Firebase. Coba lagi nanti ya Boss! üôè", false, "HERO/error.png");
            }
        }

        async function getAdminDetailedInfo(mode) {
            try {
                const sSnap = await db.ref('admin_status').once('value');
                const bSnap = await db.ref('admin_balance').once('value');
                const s = sSnap.val() || { wall: "Offline", riz: "Offline" };
                const b = bSnap.val() || { wall: 0, riz: 0 };

                let intro = mode === 'status' ? "Laporan <b>Status Admin</b>: üìä" : "Laporan <b>Saldo Admin</b>: üí∞";
                let content = `<div class="info-card">`;
                if (mode === 'status') {
                    content += `<div class="admin-status-item"><span>Admin <b>Wall</b></span><span>${s.wall === "Online" ? "üü¢ Online" : "üî¥ Offline"}</span></div>`;
                    content += `<div class="admin-status-item"><span>Admin <b>Riz</b></span><span>${s.riz === "Online" ? "üü¢ Online" : "üî¥ Offline"}</span></div>`;
                } else {
                    content += `<div class="admin-status-item"><span>Saldo <b>Wall</b></span><span>Rp ${Number(b.wall).toLocaleString('id-ID')}</span></div>`;
                    content += `<div class="admin-status-item"><span>Saldo <b>Riz</b></span><span>Rp ${Number(b.riz).toLocaleString('id-ID')}</span></div>`;
                }
                content += `</div>`;
                return intro + content;
            } catch (e) { return "Gagal ambil data Boss. üôè"; }
        }

        function showIdInput() {
            const autoID = getAutoUserID();
            addMessage("Saya ingin cek riwayat pesanan", 'user');
            processSearch(autoID);
        }

        async function processSearch(id) {
            document.getElementById('typing-ui').style.display = 'block';
            try {
                const snap = await db.ref('orders').once('value');
                const orders = snap.val();
                let found = [];
                if(orders) Object.keys(orders).forEach(k => { if(orders[k].userID === id) found.push(orders[k]); });

                let response = found.length > 0 ? `Hore! Ada <b>${found.length}</b> pesanan: üéØ<br>` : "Halo Kak! üëã Sepertinya kamu <b>belum memiliki pesanan</b> di NoxPay.<br><br>Yuk, buat pesanan pertama kamu sekarang! üöÄ";
                if(found.length > 0) {
                    found.reverse().slice(0, 3).forEach(o => {
                        response += `<div class="order-card"><b>üì¶ ${o.product}</b><br><span class="status-badge" style="background:${o.status === 'CANCEL' ? '#ef4444' : '#22c55e'}">${o.status}</span></div>`;
                    });
                }
                document.getElementById('typing-ui').style.display = 'none';
                typeWriterMessage(response, false, "HERO/search.png");
            } catch (e) { typeWriterMessage("Gagal memuat data! üò≠", false, "HERO/error.png"); }
        }

        function addMessage(text, sender) {
            const chatContainer = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `msg msg-${sender}`;
            div.innerHTML = text;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function typeWriterMessage(text, showMenu = false, imgPath = "HERO/noxie2.png") {
            const chatContainer = document.getElementById('chat-container');
            const wrapper = document.createElement('div');
            const isRight = responseCount % 2 !== 0;
            wrapper.className = `msg-wrapper ${isRight ? 'reverse' : ''}`;
            const msgDiv = document.createElement('div');
            msgDiv.className = "msg msg-noxie";
            const charDiv = document.createElement('div');
            charDiv.className = 'char-container';
            charDiv.innerHTML = `<img src="${imgPath}" alt="Noxie">`;
            wrapper.appendChild(msgDiv);
            wrapper.appendChild(charDiv);
            chatContainer.appendChild(wrapper);
            responseCount++;

            let i = 0;
            const interval = setInterval(() => {
                msgDiv.innerHTML = text.substring(0, i) + " |";
                i++;
                chatContainer.scrollTop = chatContainer.scrollHeight;
                if (i > text.length) {
                    clearInterval(interval);
                    msgDiv.innerHTML = text;
                    if(showMenu) document.getElementById('menu-btn').style.display = 'block';
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }, 6);
        }
    </script>
</body>
</html>
